<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Conti Train Board</title>

<style>
  body{margin:0;padding:0;background:#000;color:#ffb000;font-family:"Courier New",monospace;font-size:16px}
  input,button{font-family:"Courier New",monospace;font-size:16px;margin:5px;padding:6px;background:#000;color:#ffb000;border:1px solid #ffb000}
  button:hover{background:#111;cursor:pointer}
  .banner{background:#0000ff;color:#ffb000;text-align:center;font-weight:bold;padding:6px;letter-spacing:1px}
  .row-actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:8px 10px}
  #boardContainer{border-top:2px solid #ffb000;border-bottom:2px solid #ffb000}
  table{border-collapse:collapse;width:100%}
  th,td{padding:6px 8px;border-bottom:1px solid #222;text-align:left;vertical-align:top}
  th{border-bottom:2px solid #ffb000}
  .destination{color:#00ffff}
  .status-on{color:#00ff00}
  .status-warn{color:#ff0000}
  .expandable{cursor:pointer}
  .expandable:hover{background:#111}
  .stop-details{background:#111;color:#00ffff}
  .highlight{background:#550000;color:#ff0000;font-weight:bold}
  /* hidden debug panel */
  #debugPanel{display:none;color:#00ffff;border-top:1px solid #00ffff;margin:10px;padding:10px;font-size:13px;white-space:pre-wrap;word-break:break-word}
</style>
</head>

<body>
  <div class="banner" id="titleBar">CONTi TRAIN BOARD</div>

  <div class="row-actions">
    <input id="stationInput" placeholder="Station name (e.g. Wallington / London Farringdon)" />
    <button onclick="showDepartures()">Show Departures</button>
    <button onclick="useDefault()">Default Station</button>
  </div>

  <div class="row-actions">
    <input id="preferredDest" placeholder="Preferred destination (exact)" />
    <input id="preferredTime" placeholder="Time HH:MM" />
    <button onclick="setPreferredTrain()">Set Alert</button>
    <button onclick="clearPreferredTrain()">Clear</button>
  </div>

  <div id="boardContainer">
    <table id="departureTable"></table>
  </div>

  <hr style="border:1px solid #ffb000; margin:15px 0;" />

  <div class="banner">JOURNEY PLANNER</div>
  <div class="row-actions">
    <input id="fromInput" placeholder="From station" />
    <input id="toInput" placeholder="To station" />
    <input id="dateInput" type="date" />
    <input id="timeInput" type="time" value="12:00" />
    <button onclick="planJourney()">Find Routes</button>
  </div>

  <div id="journeyContainer">
    <table id="journeyTable"></table>
  </div>

  <div id="debugPanel"></div>

<script>
/*** üîë PUT YOUR REAL KEYS HERE ***/
const APP_ID = "9aa3a09a";
const APP_KEY = "c72f2155c9d5ac0c83b0bf6793b66aff";

/*** Defaults ***/
const DEFAULT_STATION = "Wallington";

/*** Preferred train set via the page ***/
let PREFERRED_TRAIN = { destination:"", aimed_departure_time:"" };
let lastAlertSignature = "";

/*** Hidden debug (tap title 5x) ***/
let titleTaps = 0;
document.getElementById("titleBar").addEventListener("click", () => {
  titleTaps++;
  if (titleTaps >= 5) {
    const p = document.getElementById("debugPanel");
    p.style.display = (p.style.display === "none") ? "block" : "none";
    titleTaps = 0;
  }
});
function debug(msg){
  const p = document.getElementById("debugPanel");
  if (p.style.display === "block") p.textContent = msg;
}

function requireKeys(){
  if(!APP_ID || APP_ID.includes("YOUR_") || !APP_KEY || APP_KEY.includes("YOUR_")){
    alert("Add your TransportAPI APP_ID and APP_KEY in the code first.");
    return false;
  }
  return true;
}

async function fetchJson(url){
  debug("GET " + url);
  const res = await fetch(url);
  const text = await res.text();
  let json = null;
  try { json = JSON.parse(text); } catch(e) {}
  if(!res.ok){
    const msg = (json && (json.error || json.message)) ? (json.error || json.message) : text.slice(0,200);
    throw new Error(`HTTP ${res.status}: ${msg}`);
  }
  if(!json) throw new Error("Response was not JSON");
  return json;
}

/*** Station lookup (name -> best place -> CRS)
     Uses TransportAPI Places text search.  [oai_citation:4‚Ä°TransportAPI Developer Portal](https://developer.transportapi.com/examples?example=places-text-search&utm_source=chatgpt.com)
***/
function guessCRS(obj){
  // Try common fields
  const direct = obj.station_code || obj.crs_code || obj.crs || obj.code;
  if (typeof direct === "string" && /^[A-Z]{3}$/.test(direct)) return direct;

  // Scan string values for a 3-letter CRS-looking code (best-effort)
  for (const k of Object.keys(obj)) {
    const v = obj[k];
    if (typeof v === "string" && /^[A-Z]{3}$/.test(v)) return v;
    if (v && typeof v === "object") {
      const nested = guessCRS(v);
      if (nested) return nested;
    }
  }
  return null;
}

async function lookupPlace(name){
  const url = `https://transportapi.com/v3/uk/places.json?query=${encodeURIComponent(name)}&type=train_station&app_id=${APP_ID}&app_key=${APP_KEY}`;
  const data = await fetchJson(url);
  const members = data.member || data.members || data.places || [];
  if (!members.length) return null;

  const best = members[0];
  return {
    name: best.name || name,
    crs: guessCRS(best),
    raw: best
  };
}

function useDefault(){
  document.getElementById("stationInput").value = DEFAULT_STATION;
  showDepartures();
}

function setPreferredTrain(){
  const dest = document.getElementById("preferredDest").value.trim();
  const time = document.getElementById("preferredTime").value.trim();
  if(!dest || !time){ alert("Enter destination AND time"); return; }
  PREFERRED_TRAIN = { destination: dest, aimed_departure_time: time };
  lastAlertSignature = "";
  alert(`Preferred train set: ${dest} at ${time}`);
}
function clearPreferredTrain(){
  PREFERRED_TRAIN = { destination:"", aimed_departure_time:"" };
  lastAlertSignature = "";
  alert("Preferred train cleared");
}

function statusClass(status){
  const s = String(status || "").toLowerCase();
  if(s.includes("on time") || s === "on time") return "status-on";
  if(s.includes("delayed") || s.includes("cancel")) return "status-warn";
  return "";
}

/*** Departures (live) ***/
async function showDepartures(){
  if(!requireKeys()) return;
  try{
    const name = (document.getElementById("stationInput").value || DEFAULT_STATION).trim();
    const place = await lookupPlace(name);

    if(!place || !place.crs){
      alert("Station not found. Try a more specific name (e.g. 'London Farringdon').");
      debug("Lookup result:\n" + JSON.stringify(place, null, 2));
      return;
    }

    // This endpoint is known working for TransportAPI train departures.  [oai_citation:5‚Ä°Home Assistant](https://www.home-assistant.io/integrations/uk_transport/?utm_source=chatgpt.com)
    const url = `https://transportapi.com/v3/uk/train/station/${place.crs}/live.json?app_id=${APP_ID}&app_key=${APP_KEY}&darwin=true`;
    const data = await fetchJson(url);

    const trains = (data.departures && (data.departures.all || data.departures)) ? (data.departures.all || data.departures) : [];
    renderDepartures(trains, data.station_name || place.name, place.crs);
  } catch(err){
    alert(String(err));
  }
}

function renderDepartures(trains, stationDisplay, crs){
  const table = document.getElementById("departureTable");
  table.innerHTML = `
    <tr><th colspan="4">${String(stationDisplay).toUpperCase()} (${crs}) DEPARTURES</th></tr>
    <tr><th>Time</th><th>Destination</th><th>Plat</th><th>Status</th></tr>
  `;

  if(!Array.isArray(trains) || trains.length === 0){
    table.innerHTML += `<tr><td colspan="4">No departures returned.</td></tr>`;
    return;
  }

  trains.slice(0, 12).forEach(train => {
    const time = train.aimed_departure_time || train.expected_departure_time || "-";
    const dest = train.destination_name || "-";
    const plat = train.platform || "-";
    const stat = train.status || "‚Äî";
    const timetableId = train.service_timetable && train.service_timetable.id ? train.service_timetable.id : null;

    const row = document.createElement("tr");
    row.classList.add("expandable");

    // highlight preferred train if delayed/cancelled
    if (PREFERRED_TRAIN.destination && PREFERRED_TRAIN.aimed_departure_time) {
      const matches = (dest === PREFERRED_TRAIN.destination && time === PREFERRED_TRAIN.aimed_departure_time);
      const bad = String(stat).toLowerCase().includes("delay") || String(stat).toLowerCase().includes("cancel");
      if(matches && bad) row.classList.add("highlight");
    }

    row.innerHTML = `
      <td>${time}</td>
      <td class="destination">${dest}</td>
      <td>${plat}</td>
      <td class="${statusClass(stat)}">${stat}</td>
    `;

    if(timetableId){
      row.onclick = () => toggleStops(timetableId, row);
    } else {
      row.onclick = () => alert("No timetable link available for this service.");
    }

    table.appendChild(row);
  });

  checkPreferredTrain(trains);
}

function buildAuthedUrl(maybeUrl){
  let url = maybeUrl;
  if(!url) return null;
  if(url.startsWith("/")) url = "https://transportapi.com" + url;
  const hasKeys = url.includes("app_id=") || url.includes("app_key=");
  const joiner = url.includes("?") ? "&" : "?";
  return hasKeys ? url : (url + joiner + `app_id=${encodeURIComponent(APP_ID)}&app_key=${encodeURIComponent(APP_KEY)}`);
}

/*** Click a train -> stops + times ***/
async function toggleStops(timetableId, row){
  const next = row.nextElementSibling;
  if(next && next.classList.contains("stop-details")){
    next.remove();
    return;
  }

  try{
    const url = buildAuthedUrl(timetableId);
    const data = await fetchJson(url);

    const stops = data.stops || (data.timetable && data.timetable.stops) || data.calling_points || [];
    const lines = (Array.isArray(stops) ? stops : []).map(s => {
      const t = s.aimed_arrival_time || s.aimed_departure_time || s.arrival_time || s.departure_time || "";
      const n = s.station_name || (s.station && s.station.name) || s.name || "";
      return `${t}  ${n}`.trim();
    }).filter(Boolean);

    const detail = document.createElement("tr");
    detail.classList.add("stop-details");
    detail.innerHTML = `<td colspan="4"><b>Stops:</b><br>${lines.length ? lines.join("<br>") : "No stops returned."}</td>`;
    row.after(detail);
  } catch(err){
    alert(String(err));
  }
}

/*** Preferred train alert (popup) ***/
function checkPreferredTrain(trains){
  if(!PREFERRED_TRAIN.destination || !PREFERRED_TRAIN.aimed_departure_time) return;

  const match = trains.find(t => {
    const time = t.aimed_departure_time || t.expected_departure_time || "";
    const dest = t.destination_name || "";
    return (dest === PREFERRED_TRAIN.destination && time === PREFERRED_TRAIN.aimed_departure_time);
  });

  if(!match) return;

  const statTxt = String(match.status || "");
  const stat = statTxt.toLowerCase();
  const bad = stat.includes("delay") || stat.includes("cancel");
  if(!bad) return;

  const signature = `${PREFERRED_TRAIN.destination}|${PREFERRED_TRAIN.aimed_departure_time}|${statTxt}`;
  if(signature !== lastAlertSignature){
    lastAlertSignature = signature;
    alert(`‚ö†Ô∏è Preferred train: ${PREFERRED_TRAIN.destination} ${PREFERRED_TRAIN.aimed_departure_time}\nStatus: ${statTxt}`);
  }
}

/*** Journey Planner (tries 2 formats) ***/
async function planJourney(){
  if(!requireKeys()) return;

  const fromName = document.getElementById("fromInput").value.trim();
  const toName = document.getElementById("toInput").value.trim();
  const date = document.getElementById("dateInput").value;
  const time = document.getElementById("timeInput").value;

  if(!fromName || !toName || !date || !time){
    alert("Fill From, To, date and time");
    return;
  }

  try{
    const from = await lookupPlace(fromName);
    const to = await lookupPlace(toName);

    if(!from || !to || !from.crs || !to.crs){
      alert("Couldn‚Äôt find one of the stations. Try a more specific name.");
      return;
    }

    // Attempt A: /public/journey/.../at/YYYY-MM-DD/HH:MM  (seen in common usage)  [oai_citation:6‚Ä°Stack Overflow](https://stackoverflow.com/questions/45637711/how-to-use-transportapi-to-generate-a-route-at-a-specified-time?utm_source=chatgpt.com)
    const urlA = `https://transportapi.com/v3/uk/public/journey/from/train_station:${from.crs}/to/train_station:${to.crs}/at/${date}/${time}.json?app_id=${APP_ID}&app_key=${APP_KEY}`;

    // Attempt B: same endpoint with datetime query (some integrations use this style)  [oai_citation:7‚Ä°Stack Overflow](https://stackoverflow.com/questions/45637711/how-to-use-transportapi-to-generate-a-route-at-a-specified-time?utm_source=chatgpt.com)
    const datetime = `${date}T${time}`;
    const urlB = `https://transportapi.com/v3/uk/public/journey/from/train_station:${from.crs}/to/train_station:${to.crs}.json?datetime=${encodeURIComponent(datetime)}&app_id=${APP_ID}&app_key=${APP_KEY}`;

    let data;
    try { data = await fetchJson(urlA); }
    catch(eA) { debug("Journey A failed:\n" + eA + "\n\nTrying B‚Ä¶"); data = await fetchJson(urlB); }

    renderJourneys(data, fromName, toName, from.crs, to.crs);
  } catch(err){
    // Very common cause: journey planner not enabled on account/product  [oai_citation:8‚Ä°TransportAPI Developer Portal](https://developer.transportapi.com/examples?example=journey-planner&utm_source=chatgpt.com)
    alert(String(err) + "\n\nIf this keeps failing: your TransportAPI plan may not include Journey Planner.");
  }
}

function renderJourneys(data, fromName, toName, fromCRS, toCRS){
  const table = document.getElementById("journeyTable");
  table.innerHTML = `
    <tr><th colspan="4">Journeys: ${fromName.toUpperCase()} (${fromCRS}) ‚Üí ${toName.toUpperCase()} (${toCRS})</th></tr>
    <tr><th>Dep</th><th>Arr</th><th>Route</th><th>Status</th></tr>
  `;

  const journeys = data.routes || data.journeys || data.itineraries || [];
  if(!Array.isArray(journeys) || journeys.length === 0){
    table.innerHTML += `<tr><td colspan="4">No journeys returned (try another time/date).</td></tr>`;
    return;
  }

  journeys.slice(0,5).forEach(r => {
    const dep = r.departure_time || r.start_time || (r.legs && r.legs[0] && (r.legs[0].departure_time || r.legs[0].start_time)) || "-";
    const arr = r.arrival_time || r.end_time || (r.legs && r.legs[r.legs.length-1] && (r.legs[r.legs.length-1].arrival_time || r.legs[r.legs.length-1].end_time)) || "-";
    const legs = (r.legs || []).map(l => `${l.origin_name||l.origin||""}‚Üí${l.destination_name||l.destination||""}`).filter(Boolean).join(", ");
    const stat = r.status || "‚Äî";

    table.innerHTML += `
      <tr>
        <td>${dep}</td>
        <td>${arr}</td>
        <td class="destination">${legs || "Route details unavailable"}</td>
        <td class="${statusClass(stat)}">${stat}</td>
      </tr>
    `;
  });
}

/*** Auto-refresh departures every 30s ***/
(async function init(){
  document.getElementById("stationInput").value = DEFAULT_STATION;
  await showDepartures();
  setInterval(() => { showDepartures().catch(()=>{}); }, 30000);
})();
</script>
</body>
</html>
