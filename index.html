<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UK Live Train Board + Journey Planner</title>

<style>
body {
    margin: 0;
    background: black;
    color: #ffb000;
    font-family: "Courier New", monospace;
    text-align: center;
}

h1, h2 {
    margin: 10px;
}

input, button {
    padding: 8px;
    font-size: 16px;
    margin: 5px;
}

.board {
    margin-top: 10px;
    width: 95%;
    margin-left: auto;
    margin-right: auto;
}

.header, .row {
    display: grid;
    grid-template-columns: 70px 1fr 60px 100px;
    padding: 6px 0;
    border-bottom: 1px solid #331f00;
}

.header {
    font-weight: bold;
    border-bottom: 2px solid #ffb000;
}

.delayed { color: yellow; }
.cancelled { color: red; }
</style>
</head>

<body>

<h1>UK Train Departures</h1>

<!-- Live Departures -->
<div>
    <input id="stationNameInput" placeholder="Station name (e.g. Wallington)">
    <button onclick="loadBoard()">Show Departures</button>
</div>

<div class="board" id="board"></div>

<hr style="border:1px solid #ffb000; width:90%; margin:20px auto;">

<h2>Journey Planner</h2>

<div>
    <input id="fromStation" placeholder="From station">
    <input id="toStation" placeholder="To station">
    <input id="journeyDate" type="date">
    <input id="journeyTime" type="time" value="12:00">
    <button onclick="planJourney()">Find Trains</button>
</div>

<div class="board" id="journeyBoard"></div>

<script>
// ======== TransportAPI credentials ========
const APP_ID = "9aa3a09a";
const APP_KEY = "c72f2155c9d5ac0c83b0bf6793b66aff";

// ======== Default station ========
let DEFAULT_STATION = "Wallington";

// ======== Function to lookup CRS code by station name ========
// List of common stations can be expanded
const stationsCRS = {
    "Wallington": "WLT",
    "Farringdon": "ZFD",
    "London Euston": "EUS",
    "Manchester Piccadilly": "MAN",
    "Birmingham New Street": "BHM"
};

function getCRS(stationName) {
    return stationsCRS[stationName] || null;
}

// ======== Load departures ========
async function loadBoard() {
    let stationName = document.getElementById("stationNameInput").value || DEFAULT_STATION;
    let crs = getCRS(stationName);
    if(!crs){
        alert("Station not recognized. Try Wallington, Farringdon, or add to station list.");
        return;
    }

    const url = `https://transportapi.com/v3/uk/train/station/${crs}/live.json?app_id=${APP_ID}&app_key=${APP_KEY}`;

    const board = document.getElementById("board");
    board.innerHTML = "Loading...";

    try{
        const res = await fetch(url);
        const data = await res.json();

        if(!data || !data.departures){
            board.innerHTML = "No departures found";
            return;
        }

        let html = `<div class="header">
                        <div>Time</div>
                        <div>Destination</div>
                        <div>Plat</div>
                        <div>Status</div>
                    </div>`;

        data.departures.all.slice(0,10).forEach(train=>{
            let statusClass = "";
            if(train.status.toLowerCase().includes("delayed")) statusClass="delayed";
            if(train.status.toLowerCase().includes("cancel")) statusClass="cancelled";

            html += `<div class="row ${statusClass}">
                        <div>${train.aimed_departure_time}</div>
                        <div>${train.destination_name}</div>
                        <div>${train.platform||"-"}</div>
                        <div>${train.status}</div>
                    </div>`;
        });

        board.innerHTML = html;

    } catch(e){
        board.innerHTML = "Error loading departures";
    }
}

// ======== Journey Planner ========
async function planJourney(){
    const fromName = document.getElementById("fromStation").value;
    const toName = document.getElementById("toStation").value;
    const date = document.getElementById("journeyDate").value;
    const time = document.getElementById("journeyTime").value;

    const fromCRS = getCRS(fromName);
    const toCRS = getCRS(toName);

    if(!fromCRS || !toCRS || !date || !time){
        alert("Please fill in From, To, date and time");
        return;
    }

    const url = `https://transportapi.com/v3/uk/train/journey/from/${fromCRS}/to/${toCRS}/${date}/${time}.json?app_id=${APP_ID}&app_key=${APP_KEY}`;

    const journeyBoard = document.getElementById("journeyBoard");
    journeyBoard.innerHTML = "Loading...";

    try{
        const res = await fetch(url);
        const data = await res.json();

        if(!data || !data.journeys){
            journeyBoard.innerHTML = "No journeys found";
            return;
        }

        let html = `<div class="header">
                        <div>Dep Time</div>
                        <div>Arr Time</div>
                        <div>From → To</div>
                        <div>Status</div>
                    </div>`;

        data.journeys.slice(0,5).forEach(journey=>{
            const dep = journey.departure_time;
            const arr = journey.arrival_time;
            const legs = journey.legs.map(l=>`${l.origin_name}→${l.destination_name}`).join(", ");
            const status = journey.status || "On time";

            html += `<div class="row ${status.toLowerCase().includes("cancel")?"cancelled":""}">
                        <div>${dep}</div>
                        <div>${arr}</div>
                        <div>${legs}</div>
                        <div>${status}</div>
                    </div>`;
        });

        journeyBoard.innerHTML = html;

    } catch(e){
        journeyBoard.innerHTML = "Error fetching journeys";
    }
}

// ======== Auto-load default departures ========
loadBoard();
setInterval(loadBoard, 30000); // Refresh every 30s
</script>

</body>
</html>
