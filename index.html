<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>CEEFAX-Style UK Train Board</title>

<style>
body {
    margin: 0;
    padding: 0;
    background: black;
    color: #ffb000;
    font-family: "Courier New", monospace;
    font-size: 16px;
}
h1,h2 { margin: 10px; text-align:center; }
input, button {
    font-family: "Courier New", monospace;
    font-size: 16px;
    margin: 5px;
    padding: 6px;
    background: black;
    color: #ffb000;
    border: 1px solid #ffb000;
}
button:hover { background:#222; cursor:pointer; }

#boardContainer {
    width: 100%;
    overflow: hidden;
    height: 350px; /* visible area */
    border-top:2px solid #ffb000;
    border-bottom:2px solid #ffb000;
}

#departureTable {
    border-collapse: collapse;
    width: 100%;
}

th, td {
    padding: 4px 6px;
    text-align: left;
}

th { border-bottom:2px solid #ffb000; }

.expandable { cursor:pointer; }
.expandable:hover { background:#111; }

.stop-details {
    background:#111;
    display:none;
    padding-left:10px;
}

.highlight { background: #550000; color: #ffb000; font-weight:bold; }

.scroller {
    display:block;
    animation: scrollUp linear infinite;
}

@keyframes scrollUp {
    0% { transform: translateY(0); }
    100% { transform: translateY(-100%); }
}
</style>
</head>
<body>

<h1>CEEFAX-STYLE TRAIN BOARD</h1>

<!-- Station selection -->
<div>
    <input id="stationInput" placeholder="Enter station name">
    <button onclick="showDepartures()">Show Departures</button>
    <button onclick="useDefault()">Default Station</button>
</div>

<!-- Preferred train -->
<div>
    <input id="preferredDest" placeholder="Preferred train destination">
    <input id="preferredTime" placeholder="Departure time HH:MM">
    <button onclick="setPreferredTrain()">Set Preferred Train</button>
</div>

<!-- Scrolling departures container -->
<div id="boardContainer">
<table id="departureTable"></table>
</div>

<hr style="border:1px solid #ffb000; margin:15px 0;">

<h2>JOURNEY PLANNER</h2>
<div>
    <input id="fromInput" placeholder="From station">
    <input id="toInput" placeholder="To station">
    <input id="dateInput" type="date">
    <input id="timeInput" type="time" value="12:00">
    <button onclick="planJourney()">Find Routes</button>
</div>

<table id="journeyTable"></table>

<script>
// üîë TransportAPI credentials
const APP_ID = "9aa3a09a";
const APP_KEY = "c72f2155c9d5ac0c83b0bf6793b66aff";

// Default station
const DEFAULT_STATION = "Wallington";

// Preferred train (set via input)
let PREFERRED_TRAIN = { destination: "", aimed_departure_time: "" };

// ‚Äî‚Äî CRS lookup
async function lookupCRS(stationName){
    const url = `https://transportapi.com/v3/uk/train/stations/name.json?query=${encodeURIComponent(stationName)}&app_id=${APP_ID}&app_key=${APP_KEY}`;
    const res = await fetch(url);
    const data = await res.json();
    if(data && data.stations && data.stations.length>0) return data.stations[0].station_code;
    return null;
}

// ‚Äî‚Äî Preferred train input
function setPreferredTrain(){
    const dest = document.getElementById("preferredDest").value.trim();
    const time = document.getElementById("preferredTime").value.trim();
    if(dest && time){
        PREFERRED_TRAIN.destination = dest;
        PREFERRED_TRAIN.aimed_departure_time = time;
        alert(`Preferred train set: ${dest} at ${time}`);
    } else alert("Enter both destination and time");
}

// ‚Äî‚Äî Departures
async function showDepartures(){
    const name = document.getElementById("stationInput").value.trim() || DEFAULT_STATION;
    const crs = await lookupCRS(name);
    if(!crs){ alert("Station not found"); return; }
    fetchDepartures(crs, name);
}
function useDefault(){ document.getElementById("stationInput").value = DEFAULT_STATION; showDepartures(); }

async function fetchDepartures(crs, displayName){
    const url = `https://transportapi.com/v3/uk/train/station/${crs}/live.json?app_id=${APP_ID}&app_key=${APP_KEY}`;
    const res = await fetch(url);
    const data = await res.json();
    renderDepartures(data, displayName);
}

function renderDepartures(data, displayName){
    const table = document.getElementById("departureTable");
    table.innerHTML = `<tr><th colspan="4">Departures from ${displayName.toUpperCase()}</th></tr>
        <tr><th>Time</th><th>Destination</th><th>Plat</th><th>Status</th></tr>`;

    if(!data.departures || !data.departures.all){
        table.innerHTML += "<tr><td colspan='4'>No departures found</td></tr>";
        return;
    }

    // Create scroller container
    const scroller = document.createElement("tbody");
    scroller.classList.add("scroller");

    data.departures.all.slice(0,20).forEach(train=>{
        const row = document.createElement("tr");
        row.classList.add("expandable");

        if(train.destination_name === PREFERRED_TRAIN.destination &&
           train.aimed_departure_time === PREFERRED_TRAIN.aimed_departure_time &&
           train.status.toLowerCase().includes("delay")) row.classList.add("highlight");

        row.innerHTML = `<td>${train.aimed_departure_time}</td>
                         <td>${train.destination_name}</td>
                         <td>${train.platform||"-"}</td>
                         <td>${train.status}</td>`;
        row.onclick = ()=> showStops(train.service_timetable.id, row);
        scroller.appendChild(row);
    });
    table.appendChild(scroller);

    // Trigger preferred train alert
    checkPreferredTrain(data.departures.all);

    // Adjust scrolling duration based on number of rows
    const duration = Math.max(15, data.departures.all.length); // seconds
    scroller.style.animationDuration = `${duration}s`;
}

// Show stops
async function showStops(serviceId, row){
    const nextRow = row.nextSibling;
    if(nextRow && nextRow.classList && nextRow.classList.contains("stop-details")){ nextRow.remove(); return; }

    const url = `https://transportapi.com/v3/uk/train/service/train/${serviceId}/timetable.json?app_id=${APP_ID}&app_key=${APP_KEY}`;
    const res = await fetch(url);
    const data = await res.json();

    const detailRow = document.createElement("tr");
    detailRow.classList.add("stop-details");
    detailRow.innerHTML = `<td colspan="4"><b>Stops:</b><br>${
        data.stops.map(stop=>`${stop.aimed_arrival_time || stop.aimed_departure_time} - ${stop.station_name}`).join("<br>")
    }</td>`;
    row.after(detailRow);
}

// Preferred train check
function checkPreferredTrain(departures){
    if(!PREFERRED_TRAIN.destination || !PREFERRED_TRAIN.aimed_departure_time) return;
    const train = departures.find(t =>
        t.destination_name === PREFERRED_TRAIN.destination &&
        t.aimed_departure_time === PREFERRED_TRAIN.aimed_departure_time
    );
    if(train && train.status.toLowerCase().includes("delay")){
        alert(`‚ö†Ô∏è Your preferred train to ${PREFERRED_TRAIN.destination} at ${PREFERRED_TRAIN.aimed_departure_time} is ${train.status}`);
    }
}

// ‚Äî‚Äî Journey Planner
async function planJourney(){
    const fromName = document.getElementById("fromInput").value.trim();
    const toName = document.getElementById("toInput").value.trim();
    const date = document.getElementById("dateInput").value;
    const time = document.getElementById("timeInput").value;

    if(!fromName || !toName || !date || !time){ alert("Fill all fields"); return; }

    const fromCRS = await lookupCRS(fromName);
    const toCRS = await lookupCRS(toName);
    if(!fromCRS || !toCRS){ alert("One or both stations not found"); return; }

    const url = `https://transportapi.com/v3/uk/train/journey/from/${fromCRS}/to/${toCRS}/${date}/${time}.json?app_id=${APP_ID}&app_key=${APP_KEY}`;
    const res = await fetch(url);
    const data = await res.json();
    renderJourney(data);
}

function renderJourney(data){
    const table = document.getElementById("journeyTable");
    table.innerHTML = `<tr><th colspan="4">Journey Results</th></tr>
        <tr><th>Dep Time</th><th>Arr Time</th><th>Route</th><th>Status</th></tr>`;

    if(!data.journeys){ table.innerHTML += "<tr><td colspan='4'>No journeys</td></tr>"; return; }

    data.journeys.slice(0,5).forEach(journey=>{
        const legs = journey.legs.map(l=>`${l.origin_name}‚Üí${l.destination_name}`).join(", ");
        const row = document.createElement("tr");
        row.innerHTML = `<td>${journey.departure_time}</td>
                         <td>${journey.arrival_time}</td>
                         <td>${legs}</td>
                         <td>${journey.status || "On time"}</td>`;
        table.appendChild(row);
    });
}

// Auto-load default departures
showDepartures();
setInterval(showDepartures, 30000);
</script>
</body>
</html>
