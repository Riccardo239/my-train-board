<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Conti Train Board</title>

<style>
  body{margin:0;padding:0;background:#000;color:#ffb000;font-family:"Courier New",monospace;font-size:16px}
  input,button{font-family:"Courier New",monospace;font-size:16px;margin:5px;padding:6px;background:#000;color:#ffb000;border:1px solid #ffb000}
  button:hover{background:#111;cursor:pointer}
  .banner{background:#0000ff;color:#ffb000;text-align:center;font-weight:bold;padding:6px;letter-spacing:1px}
  .subtle{color:#00ff00;text-align:center;margin:6px 10px}
  .debug{color:#00ffff;text-align:center;margin:6px 10px;font-size:14px;word-break:break-word}
  #boardContainer{border-top:2px solid #ffb000;border-bottom:2px solid #ffb000}
  table{border-collapse:collapse;width:100%}
  th,td{padding:6px 8px;border-bottom:1px solid #222;text-align:left;vertical-align:top}
  th{border-bottom:2px solid #ffb000}
  .destination{color:#00ffff}
  .status-on{color:#00ff00}
  .status-warn{color:#ff0000}
  .expandable{cursor:pointer}
  .expandable:hover{background:#111}
  .stop-details{background:#111;color:#00ffff}
  .highlight{background:#550000;color:#ff0000;font-weight:bold}
  .row-actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin:6px 10px}
  .small{font-size:14px}
</style>
</head>

<body>
  <div class="banner">CONTi TRAIN BOARD</div>
  <div class="subtle small" id="statusLine">Ready</div>
  <div class="debug" id="debugLine"></div>

  <div class="row-actions">
    <input id="stationInput" placeholder="Station name (e.g. Wallington / Farringdon)" />
    <button onclick="showDepartures()">Show Departures</button>
    <button onclick="useDefault()">Default Station</button>
  </div>

  <div class="row-actions">
    <input id="preferredDest" placeholder="Preferred destination (exact)" />
    <input id="preferredTime" placeholder="Time HH:MM" />
    <button onclick="setPreferredTrain()">Set Alert</button>
    <button onclick="clearPreferredTrain()">Clear</button>
  </div>

  <div id="boardContainer">
    <table id="departureTable"></table>
  </div>

  <hr style="border:1px solid #ffb000; margin:15px 0;" />

  <div class="banner">JOURNEY PLANNER</div>
  <div class="row-actions">
    <input id="fromInput" placeholder="From station" />
    <input id="toInput" placeholder="To station" />
    <input id="dateInput" type="date" />
    <input id="timeInput" type="time" value="12:00" />
    <button onclick="planJourney()">Find Routes</button>
  </div>

  <div id="journeyContainer">
    <table id="journeyTable"></table>
  </div>

<script>
/*** ✅ PUT YOUR REAL KEYS HERE ***/
const APP_ID = "9aa3a09a";
const APP_KEY = "c72f2155c9d5ac0c83b0bf6793b66aff";

/*** Defaults ***/
const DEFAULT_STATION = "Wallington";
let lastStationName = DEFAULT_STATION;
let lastStationCRS = null;

/*** Preferred train set via the page ***/
let PREFERRED_TRAIN = { destination:"", aimed_departure_time:"" };
let lastAlertSignature = ""; // stop repeated alert spam

function setStatus(msg){ document.getElementById("statusLine").innerText = msg; }
function setDebug(msg){ document.getElementById("debugLine").innerText = msg || ""; }

function setPreferredTrain(){
  const dest = document.getElementById("preferredDest").value.trim();
  const time = document.getElementById("preferredTime").value.trim();
  if(!dest || !time){ alert("Enter destination AND time"); return; }
  PREFERRED_TRAIN = { destination: dest, aimed_departure_time: time };
  lastAlertSignature = "";
  alert(`Preferred train set: ${dest} at ${time}`);
}
function clearPreferredTrain(){
  PREFERRED_TRAIN = { destination:"", aimed_departure_time:"" };
  lastAlertSignature = "";
  alert("Preferred train cleared");
}

function useDefault(){
  document.getElementById("stationInput").value = DEFAULT_STATION;
  showDepartures();
}

/*** Safe fetch helper with visible errors ***/
async function fetchJson(url){
  try{
    setDebug(url);
    const res = await fetch(url);
    const text = await res.text();
    let json = null;
    try { json = JSON.parse(text); } catch(e) {}
    if(!res.ok){
      const msg = (json && (json.error || json.message)) ? (json.error || json.message) : text.slice(0,160);
      throw new Error(`HTTP ${res.status}: ${msg}`);
    }
    if(!json) throw new Error("Response was not JSON");
    return json;
  } catch(err){
    setStatus("Error");
    setDebug(String(err));
    throw err;
  }
}

/*** 1) Station name -> CRS using Places API ***/
/* Uses: /v3/uk/places.json?query=...&type=train_station&app_id=...&app_key=... */
async function lookupCRSByName(name){
  const url = `https://transportapi.com/v3/uk/places.json?query=${encodeURIComponent(name)}&type=train_station&app_id=${APP_ID}&app_key=${APP_KEY}`;
  const data = await fetchJson(url);

  // Places results are usually in "member" (JSON-LD) but may vary.
  const members = data.member || data.members || data.places || [];
  const best = members.find(x => (x.type === "train_station" || x.atcocode || x.station_code || x.station_code)) || members[0];

  if(!best) return null;

  // Common fields seen in examples/docs/blogs: station_code / station_code, sometimes in "station_code"
  const crs = best.station_code || best.station_code || best.station_code || best.crs_code || best.code;

  // Some payloads may use "station_code" inside nested "station" object
  const nested = best.station && (best.station.station_code || best.station.crs || best.station.code);

  return (crs || nested || null);
}

/*** 2) Departures (live) ***/
async function showDepartures(){
  const name = (document.getElementById("stationInput").value || DEFAULT_STATION).trim();
  if(!APP_ID || APP_ID.includes("YOUR_") || !APP_KEY || APP_KEY.includes("YOUR_")){
    alert("You must add your TransportAPI APP_ID and APP_KEY in the code first.");
    return;
  }

  setStatus(`Looking up station: ${name}…`);
  lastStationName = name;

  const crs = await lookupCRSByName(name);
  if(!crs){
    setStatus("Station not found");
    setDebug("No CRS found from places lookup. Try a more specific name (e.g. 'London Farringdon').");
    return;
  }
  lastStationCRS = crs;

  setStatus(`Fetching live departures for ${name} (${crs})…`);
  const url = `https://transportapi.com/v3/uk/train/station/${crs}/live.json?app_id=${APP_ID}&app_key=${APP_KEY}&darwin=true`;
  const data = await fetchJson(url);

  const trains = (data.departures && (data.departures.all || data.departures)) ? (data.departures.all || data.departures) : [];
  renderDepartures(trains, data.station_name || name, crs);
}

function statusClass(status){
  const s = String(status || "").toLowerCase();
  if(s.includes("on time") || s === "on time") return "status-on";
  if(s.includes("delayed") || s.includes("cancel")) return "status-warn";
  return "";
}

function renderDepartures(trains, stationDisplay, crs){
  setStatus(`Live departures: ${stationDisplay} (${crs})`);
  const table = document.getElementById("departureTable");
  table.innerHTML = `
    <tr><th colspan="4">${String(stationDisplay).toUpperCase()} DEPARTURES</th></tr>
    <tr><th>Time</th><th>Destination</th><th>Plat</th><th>Status</th></tr>
  `;

  if(!Array.isArray(trains) || trains.length === 0){
    table.innerHTML += `<tr><td colspan="4">No departures returned (check API key / limits / station name).</td></tr>`;
    return;
  }

  trains.slice(0, 12).forEach(train => {
    const time = train.aimed_departure_time || train.expected_departure_time || train.aimed_departure || "-";
    const dest = train.destination_name || (train.destination && train.destination.name) || "-";
    const plat = train.platform || "-";
    const stat = train.status || train.expected_departure_time || "—";

    const row = document.createElement("tr");
    row.classList.add("expandable");

    // Preferred train highlight/alert checks
    if (PREFERRED_TRAIN.destination && PREFERRED_TRAIN.aimed_departure_time) {
      const matches = (dest === PREFERRED_TRAIN.destination && time === PREFERRED_TRAIN.aimed_departure_time);
      const bad = String(stat).toLowerCase().includes("delay") || String(stat).toLowerCase().includes("cancel");
      if(matches && bad) row.classList.add("highlight");
    }

    row.innerHTML = `
      <td>${time}</td>
      <td class="destination">${dest}</td>
      <td>${plat}</td>
      <td class="${statusClass(stat)}">${stat}</td>
    `;

    // Click to show calling points/stops:
    // TransportAPI includes a "service_timetable.id" URL in many responses – use it directly.
    const timetableId = train.service_timetable && train.service_timetable.id ? train.service_timetable.id : null;
    if(timetableId){
      row.onclick = () => toggleStops(timetableId, row);
    } else {
      row.onclick = () => alert("No timetable link for this service in the API response.");
    }

    table.appendChild(row);
  });

  checkPreferredTrain(trains);
}

function buildAuthedUrl(maybeUrl){
  // timetableId may be a full URL or a path; ensure it has app_id/app_key.
  let url = maybeUrl;
  if(!url) return null;
  if(url.startsWith("/")) url = "https://transportapi.com" + url;
  if(!url.startsWith("http")) url = "https://transportapi.com/" + url.replace(/^\/+/, "");

  const hasApp = url.includes("app_id=") || url.includes("app_key=");
  const joiner = url.includes("?") ? "&" : "?";
  return hasApp ? url : (url + joiner + `app_id=${encodeURIComponent(APP_ID)}&app_key=${encodeURIComponent(APP_KEY)}`);
}

async function toggleStops(timetableId, row){
  const next = row.nextElementSibling;
  if(next && next.classList.contains("stop-details")){
    next.remove();
    return;
  }

  setStatus("Fetching calling points…");
  const url = buildAuthedUrl(timetableId);
  const data = await fetchJson(url);

  // Try common shapes
  const stops = data.stops || (data.timetable && data.timetable.stops) || (data.calling_points) || [];
  const lines = (Array.isArray(stops) ? stops : []).map(s => {
    const t = s.aimed_arrival_time || s.aimed_departure_time || s.departure_time || s.arrival_time || "";
    const n = s.station_name || (s.station && s.station.name) || s.name || "";
    return `${t}  ${n}`.trim();
  }).filter(Boolean);

  const detail = document.createElement("tr");
  detail.classList.add("stop-details");
  detail.innerHTML = `<td colspan="4"><b>Stops:</b><br>${lines.length ? lines.join("<br>") : "No stop list returned for this service."}</td>`;
  row.after(detail);

  setStatus(`Live departures: ${lastStationName} (${lastStationCRS})`);
}

/*** Preferred train alert (popup) ***/
function checkPreferredTrain(trains){
  if(!PREFERRED_TRAIN.destination || !PREFERRED_TRAIN.aimed_departure_time) return;

  const match = trains.find(t => {
    const time = t.aimed_departure_time || t.expected_departure_time || t.aimed_departure || "";
    const dest = t.destination_name || (t.destination && t.destination.name) || "";
    return (dest === PREFERRED_TRAIN.destination && time === PREFERRED_TRAIN.aimed_departure_time);
  });

  if(!match) return;

  const stat = String(match.status || "").toLowerCase();
  const bad = stat.includes("delay") || stat.includes("cancel");

  if(bad){
    const signature = `${PREFERRED_TRAIN.destination}|${PREFERRED_TRAIN.aimed_departure_time}|${match.status}`;
    if(signature !== lastAlertSignature){
      lastAlertSignature = signature;
      alert(`⚠️ Preferred train: ${PREFERRED_TRAIN.destination} ${PREFERRED_TRAIN.aimed_departure_time}\nStatus: ${match.status}`);
    }
  }
}

/*** 3) Journey Planner (SilverRail) ***/
async function planJourney(){
  if(!APP_ID || APP_ID.includes("YOUR_") || !APP_KEY || APP_KEY.includes("YOUR_")){
    alert("Add your TransportAPI APP_ID and APP_KEY in the code first.");
    return;
  }

  const fromName = document.getElementById("fromInput").value.trim();
  const toName = document.getElementById("toInput").value.trim();
  const date = document.getElementById("dateInput").value;
  const time = document.getElementById("timeInput").value;

  if(!fromName || !toName || !date || !time){
    alert("Fill From, To, date and time");
    return;
  }

  setStatus("Looking up From/To stations…");
  const fromCRS = await lookupCRSByName(fromName);
  const toCRS = await lookupCRSByName(toName);
  if(!fromCRS || !toCRS){
    setStatus("Station not found");
    setDebug("Could not find CRS for From or To. Try more specific names (e.g. 'London Farringdon').");
    return;
  }

  // TransportAPI examples show /v3/uk/public/journey/... with service=silverrail
  // We'll use train_station:CRS for from/to and datetime=YYYY-MM-DDTHH:MM
  const datetime = `${date}T${time}`;
  const url = `https://transportapi.com/v3/uk/public/journey/from/train_station:${fromCRS}/to/train_station:${toCRS}.json?service=silverrail&datetime=${encodeURIComponent(datetime)}&app_id=${APP_ID}&app_key=${APP_KEY}`;
  setStatus("Fetching journeys…");
  const data = await fetchJson(url);

  renderJourneys(data, fromName, toName, fromCRS, toCRS);
}

function renderJourneys(data, fromName, toName, fromCRS, toCRS){
  const table = document.getElementById("journeyTable");
  table.innerHTML = `
    <tr><th colspan="4">Journeys: ${fromName.toUpperCase()} (${fromCRS}) → ${toName.toUpperCase()} (${toCRS})</th></tr>
    <tr><th>Dep</th><th>Arr</th><th>Route</th><th>Status</th></tr>
  `;

  const journeys = data.journeys || data.routes || data.itineraries || [];
  if(!Array.isArray(journeys) || journeys.length === 0){
    table.innerHTML += `<tr><td colspan="4">No journeys returned. Check your TransportAPI plan includes Journey Planner (SilverRail) and try another time.</td></tr>`;
    setStatus("Journey search returned no results");
    return;
  }

  journeys.slice(0,5).forEach(j => {
    const dep = j.departure_time || j.start_time || (j.legs && j.legs[0] && j.legs[0].departure_time) || "-";
    const arr = j.arrival_time || j.end_time || (j.legs && j.legs[j.legs.length-1] && j.legs[j.legs.length-1].arrival_time) || "-";
    const legs = (j.legs || []).map(l => `${l.origin_name || l.origin || ""}→${l.destination_name || l.destination || ""}`).filter(Boolean).join(", ");
    const stat = j.status || "—";
    table.innerHTML += `
      <tr>
        <td>${dep}</td>
        <td>${arr}</td>
        <td class="destination">${legs || "Route details unavailable"}</td>
        <td class="${statusClass(stat)}">${stat}</td>
      </tr>
    `;
  });

  setStatus("Journeys loaded");
}

/*** Auto refresh departures every 30s ***/
(async function init(){
  document.getElementById("stationInput").value = DEFAULT_STATION;
  try { await showDepartures(); } catch(e) {}
  setInterval(() => { showDepartures().catch(()=>{}); }, 30000);
})();
</script>
</body>
</html>
